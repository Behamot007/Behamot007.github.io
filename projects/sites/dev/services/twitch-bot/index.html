<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Twitch Chat Steuerung</title>
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <header class="app-header">
      <div class="app-header__brand">
        <span class="app-header__logo">üõ†Ô∏è</span>
        <div>
          <h1>Twitch Chat Steuerung</h1>
          <p>Bot-Kanal √ºberwachen &amp; Nachrichten versenden</p>
        </div>
      </div>
      <nav class="app-header__nav">
        <a href="../../index.html">‚Üê Zur√ºck zur √úbersicht</a>
      </nav>
    </header>

    <main class="app-main">
      <nav class="page-nav" aria-label="Bereiche">
        <button type="button" class="page-nav__link is-active" data-target="config" id="nav-config">
          Konfiguration
        </button>
        <button type="button" class="page-nav__link" data-target="chat" id="nav-chat">
          Chat-Ansicht
        </button>
        <button type="button" class="page-nav__link" data-target="commands" id="nav-commands">
          Befehle
        </button>
        <button type="button" class="page-nav__link" data-target="currency" id="nav-currency">
          W√§hrung
        </button>
        <button type="button" class="page-nav__link" data-target="openai" id="nav-openai">
          OpenAI Zuschauer
        </button>
      </nav>

      <section class="page-section is-active" id="view-config" aria-labelledby="nav-config">
        <div class="cards-grid">
          <article class="card">
            <h2>Backend-Verbindung</h2>
            <form id="connectionForm" class="form-grid" method="post" autocomplete="on">
              <label>
                <span>API Benutzername (optional)</span>
                <input
                  id="apiUser"
                  name="username"
                  type="text"
                  placeholder="z. B. bot-admin"
                  autocomplete="username"
                />
              </label>
              <label>
                <span>API-Passwort</span>
                <input
                  id="apiPassword"
                  name="password"
                  type="password"
                  autocomplete="current-password"
                  required
                />
              </label>
              <div class="form-actions">
                <button type="submit">Verbinden</button>
                <button type="button" id="clearPassword" class="secondary">Passwort l√∂schen</button>
              </div>
            </form>
            <div id="connectionStatus" class="status-box">Nicht verbunden</div>
          </article>

          <article class="card">
            <h2>OAuth f√ºr Bot-Token</h2>
            <p>
              Startet den Twitch-Login in einem Pop-up. Nach erfolgreicher Anmeldung wird das neue Bot-Token automatisch im
              Backend gespeichert und bei Bedarf erneuert.
            </p>
            <div class="oauth-grid">
              <button id="oauthStart" disabled>OAuth starten</button>
              <div class="status-box" id="oauthInfo">Noch kein Token angefordert.</div>
            </div>
          </article>

          <article class="card">
            <h2>Token-Status</h2>
            <div id="tokenStatus" class="status-box">Noch kein Bot-Token hinterlegt.</div>
            <p class="card__hint">
              Tipp: F√ºr automatische Verl√§ngerung muss beim OAuth-Login das H√§kchen f√ºr <code>chat:read</code> und
              <code>chat:edit</code> gesetzt sein.
            </p>
          </article>
        </div>
      </section>

      <section class="page-section" id="view-chat" aria-labelledby="nav-chat">
        <div class="cards-grid">
          <article class="card card--wide">
            <div class="card-header">
              <h2>Chat-Ansicht</h2>
              <div class="channel-form">
                <label>
                  <span>Channel</span>
                  <input id="channelInput" type="text" placeholder="beispielkanal" />
                </label>
                <button id="connectChannel" disabled>Chat abonnieren</button>
              </div>
            </div>
            <div id="chatLog" class="chat-log" aria-live="polite"></div>
            <form id="messageForm" class="message-form">
              <textarea id="messageInput" rows="2" placeholder="Nachricht schreiben..." required></textarea>
              <button type="submit" disabled>Senden</button>
            </form>
          </article>
        </div>
      </section>

      <section class="page-section" id="view-commands" aria-labelledby="nav-commands">
        <div class="cards-grid">
          <article class="card card--wide">
            <div class="card-header">
              <div>
                <h2>Befehlsverwaltung</h2>
                <p class="card__hint">
                  Verwalte Pr√§fix, Aliase, automatische Ausf√ºhrungen und Antworten. Platzhalter wie
                  <code>{user}</code> oder <code>{channel}</code> werden automatisch ersetzt.
                </p>
              </div>
              <div class="command-prefix">
                <label>
                  <span>Befehlspr√§fix</span>
                  <input id="commandPrefix" type="text" maxlength="5" />
                </label>
              </div>
            </div>
            <div id="commandList" class="command-list" aria-live="polite"></div>
            <div class="command-actions">
              <button type="button" id="addCommand" class="secondary">Neuen Befehl hinzuf√ºgen</button>
              <button type="button" id="saveCommands">√Ñnderungen speichern</button>
            </div>
            <div id="commandStatus" class="status-box">Befehle noch nicht geladen.</div>
          </article>
        </div>
      </section>

      <section class="page-section" id="view-currency" aria-labelledby="nav-currency">
        <div class="cards-grid">
          <article class="card card--wide">
            <div class="card-header">
              <div>
                <h2>W√§hrungssystem</h2>
                <p class="card__hint">
                  Vergabe von Punkten f√ºr aktive Zuschauer konfigurieren und festlegen, wie Commands W√§hrung verbrauchen.
                </p>
              </div>
            </div>

            <form id="currencyForm" class="form-grid">
              <label>
                <span>W√§hrungsname</span>
                <input id="currencyName" type="text" maxlength="32" required />
              </label>
              <div class="field field--split">
                <label for="currencyAmount">
                  <span class="field__label">W√§hrung pro Vergabe</span>
                  <input type="number" id="currencyAmount" min="0" step="1" required />
                </label>
                <label for="currencyMinutes">
                  <span class="field__label">Vergabe alle (Minuten)</span>
                  <input type="number" id="currencyMinutes" min="1" step="1" required />
                </label>
              </div>
              <div class="form-actions">
                <button type="submit" id="currencySave">W√§hrung speichern</button>
              </div>
            </form>

            <div id="currencyStatus" class="status-box">W√§hrung noch nicht geladen.</div>

            <div class="currency-summary" id="currencySummary" hidden>
              <div class="currency-summary__item">
                <span class="currency-summary__label">Gesamtsaldo</span>
                <span class="currency-summary__value" id="currencySummaryTotal">0</span>
              </div>
              <div class="currency-summary__item">
                <span class="currency-summary__label">Aktive Konten</span>
                <span class="currency-summary__value" id="currencySummaryUsers">0</span>
              </div>
              <div class="currency-summary__item">
                <span class="currency-summary__label">Vergaberate</span>
                <span class="currency-summary__value" id="currencySummaryRate">‚Äî</span>
              </div>
            </div>
          </article>
        </div>
      </section>

      <section class="page-section" id="view-openai" aria-labelledby="nav-openai">
        <div class="cards-grid">
          <article class="card card--wide">
            <div class="card-header">
              <div>
                <h2>OpenAI Zuschauer</h2>
                <p class="card__hint">
                  Automatisch generierte Chat-Nachrichten basierend auf Screenshots des Livestreams und dem aktuellen Chat-Verlauf.
                </p>
              </div>
              <label class="switch" for="openAiEnabled">
                <input type="checkbox" id="openAiEnabled" />
                <span>Automatik aktiv</span>
              </label>
            </div>

            <form id="openAiForm" class="form-grid" autocomplete="off">
              <label>
                <span>Channel (optional)</span>
                <input id="openAiChannel" type="text" placeholder="Standardchannel verwenden" autocomplete="off" />
                <p class="field__hint">Leer lassen, um den Default-Channel aus der .env zu nutzen.</p>
              </label>

              <div class="field field--split">
                <label for="openAiInterval">
                  <span class="field__label">Intervall (Sekunden)</span>
                  <input id="openAiInterval" type="number" min="30" step="5" required />
                </label>
                <div class="field">
                  <span class="field__label">Aktionen</span>
                  <div class="form-actions">
                    <button type="submit" id="openAiSave">Konfiguration speichern</button>
                    <button type="button" id="openAiResetPrompt" class="secondary">Prompt zur√ºcksetzen</button>
                  </div>
                </div>
              </div>

              <label class="field" for="openAiPrompt">
                <span class="field__label">System-Prompt</span>
                <textarea id="openAiPrompt" rows="6" required></textarea>
                <p class="field__hint">Wird als Systemnachricht bei jeder Anfrage an OpenAI verwendet.</p>
              </label>
            </form>

            <div id="openAiStatus" class="status-box">Bitte zuerst mit dem Backend verbinden.</div>

            <div id="openAiSummary" class="openai-summary" hidden>
              <div class="openai-summary__grid">
                <div class="openai-summary__item">
                  <span class="openai-summary__label">Ziel-Channel</span>
                  <span class="openai-summary__value" id="openAiSummaryChannel">‚Äî</span>
                </div>
                <div class="openai-summary__item">
                  <span class="openai-summary__label">Intervall</span>
                  <span class="openai-summary__value" id="openAiSummaryInterval">‚Äî</span>
                </div>
                <div class="openai-summary__item">
                  <span class="openai-summary__label">N√§chster Lauf</span>
                  <span class="openai-summary__value" id="openAiSummaryNextRun">‚Äî</span>
                </div>
                <div class="openai-summary__item">
                  <span class="openai-summary__label">Letzter Erfolg</span>
                  <span class="openai-summary__value" id="openAiSummaryLastSuccess">‚Äî</span>
                </div>
                <div class="openai-summary__item">
                  <span class="openai-summary__label">Stream-Status</span>
                  <span class="openai-summary__value" id="openAiSummaryStreamStatus">‚Äî</span>
                </div>
              </div>

              <div class="openai-summary__details">
                <p><strong>Letzte Nachricht:</strong> <span id="openAiSummaryMessage">‚Äî</span></p>
                <p><strong>Tokenverbrauch:</strong> <span id="openAiSummaryTokens">‚Äî</span></p>
                <p class="openai-summary__error" id="openAiSummaryError" hidden></p>
              </div>
            </div>

            <details class="openai-debug" id="openAiDebugPanel" hidden>
              <summary class="openai-debug__summary">Debug-Details anzeigen</summary>
              <div class="openai-debug__content">
                <div class="openai-debug__latest">
                  <h3>Letzte Ausf√ºhrung</h3>
                  <p class="openai-debug__meta" id="openAiDebugMeta">Keine Daten verf√ºgbar.</p>
                  <div class="openai-debug__screenshot" id="openAiDebugScreenshotWrapper" hidden>
                    <img id="openAiDebugScreenshot" alt="Letzter verwendeter Screenshot" />
                  </div>
                  <div class="openai-debug__payloads">
                    <div class="openai-debug__payload">
                      <h4>API Anfrage</h4>
                      <pre id="openAiDebugRequest" class="openai-debug__pre"></pre>
                    </div>
                    <div class="openai-debug__payload">
                      <h4>API Antwort</h4>
                      <pre id="openAiDebugResponse" class="openai-debug__pre"></pre>
                    </div>
                  </div>
                </div>
                <div class="openai-debug__history">
                  <h3>Historie</h3>
                  <p id="openAiDebugEmpty" class="openai-debug__empty" hidden>Keine Eintr√§ge vorhanden.</p>
                  <ol id="openAiDebugHistory" class="openai-debug__history-list"></ol>
                </div>
              </div>
            </details>
          </article>
        </div>
      </section>
    </main>

    <div id="commandModal" class="modal" hidden>
      <div class="modal__content" role="dialog" aria-modal="true" aria-labelledby="commandModalTitle">
        <header class="modal__header">
          <h3 id="commandModalTitle">Befehl bearbeiten</h3>
          <button type="button" class="icon-button" data-command-modal-close aria-label="Schlie√üen">√ó</button>
        </header>
        <form id="commandForm" class="modal__form">
          <div class="modal__body">
            <label class="switch" for="commandEnabled">
              <input type="checkbox" id="commandEnabled" />
              <span>Aktiver Befehl</span>
            </label>

            <div class="field">
              <div class="field__label">Befehlsnamen</div>
              <p class="field__hint">Mehrere Aliase m√∂glich. Der Pr√§fix wird automatisch erg√§nzt.</p>
              <div id="commandNames" class="tag-list" role="list"></div>
              <div class="field__row">
                <input
                  type="text"
                  id="commandNameInput"
                  placeholder="Neuer Befehlsname"
                  autocomplete="off"
                />
                <button type="button" class="secondary" id="commandNameAdd">Hinzuf√ºgen</button>
              </div>
            </div>

            <label class="field" for="commandResponse">
              <span class="field__label">Antwort</span>
              <textarea id="commandResponse" rows="4" required></textarea>
            </label>

            <div class="field field--split">
              <label for="commandCooldown">
                <span class="field__label">Cooldown (Sek.)</span>
                <input type="number" id="commandCooldown" min="0" step="1" />
              </label>
              <label for="commandAutoInterval">
                <span class="field__label">Automatik (Sek.)</span>
                <input type="number" id="commandAutoInterval" min="0" step="1" />
              </label>
            </div>

            <label class="field" for="commandUserLevel">
              <span class="field__label">Benutzerstufe</span>
              <select id="commandUserLevel"></select>
            </label>

            <label class="field" for="commandResponseType">
              <span class="field__label">Antworttyp</span>
              <select id="commandResponseType"></select>
            </label>

            <label class="field" for="commandCost">
              <span class="field__label" id="commandCostLabel">Kosten (W√§hrung)</span>
              <input type="number" id="commandCost" min="0" step="1" />
              <p class="field__hint">Wird beim Ausf√ºhren vom Nutzerkonto abgezogen.</p>
            </label>

            <p id="commandModalError" class="modal__error" hidden></p>
          </div>
          <footer class="modal__footer">
            <button type="button" class="danger" id="commandDelete">Befehl l√∂schen</button>
            <span class="modal__spacer"></span>
            <button type="button" class="secondary" data-command-modal-cancel>Abbrechen</button>
            <button type="submit">Speichern</button>
          </footer>
        </form>
      </div>
    </div>

    <template id="messageTemplate">
      <article class="chat-message">
        <div class="chat-message__meta">
          <span class="chat-message__user"></span>
          <time class="chat-message__time"></time>
        </div>
        <p class="chat-message__text"></p>
      </article>
    </template>

    <script type="module" src="./script.js"></script>
  </body>
</html>
