<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Arena Match Analyzer</title>
  <style>
    :root { --bg:#0b1020; --card:#131a2a; --muted:#8fa1c7; --text:#e9f0ff; --accent:#6aa9ff; --good:#56d364; }
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.45 system-ui,Segoe UI,Roboto,Arial,sans-serif;padding-bottom:40px}
    header{text-align:center;padding:28px 20px 10px;}
    .wrap{max-width:1100px;margin:0 auto;padding:0 16px}
    form.tools{display:grid;gap:12px;grid-template-columns:1fr 1fr;align-items:end;margin:18px auto 14px;max-width:980px}
    .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:13px;color:var(--muted)}
    input,select,button{background:var(--card);border:1px solid #1e2a44;color:var(--text);padding:10px 12px;border-radius:10px;outline:none}
    button{cursor:pointer;background:linear-gradient(180deg,#3b6dd8,#2c5ac0);border:0;box-shadow:0 6px 18px rgba(59,109,216,.25)}
    .filehint{font-size:12px;color:#9ab0da}
    .kvs{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:10px;margin:10px 0 18px}
    .kv{background:var(--card);border:1px dashed #28406f;border-radius:12px;padding:10px 12px;font-size:13px}
    details{background:var(--card);border:1px solid #1e2a44;border-radius:8px;padding:8px 12px;margin-top:8px}
    summary{cursor:pointer;display:grid;grid-template-columns:110px 1fr 100px 60px;gap:10px;font-size:14px;align-items:center}
    summary::-webkit-details-marker{display:none}
    .details-content{margin-top:8px;font-size:13px;color:var(--muted)}
    .pagination{display:flex;gap:10px;align-items:center;justify-content:center;margin-top:12px}
    .pagination button{padding:6px 10px;background:var(--card);border:1px solid #1e2a44;border-radius:6px;color:var(--text);cursor:pointer}
  </style>
</head>
<body>
<header>
  <h1>Arena Match Analyzer</h1>
  <p class="sub">Importiere einen Datensatz aus Arena-Statistiken und analysiere deine Spiele.</p>
</header>
<div class="wrap">
  <form class="tools">
    <div class="field">
      <label for="name">Beschwörername (optional)</label>
      <input id="name" type="text" placeholder="z. B. Behamot" />
    </div>
    <div class="field">
      <label>Datensatz</label>
      <div class="row">
        <input id="importFile" type="file" accept="application/json" style="display:none" />
        <button id="importBtn" type="button">Importieren (.json)</button>
      </div>
      <div class="filehint" id="importInfo">Noch kein Datensatz importiert.</div>
    </div>
  </form>

  <div class="kvs">
    <div class="kv"><strong>Spiele:</strong> <span id="games">—</span></div>
    <div class="kv"><strong>Siege:</strong> <span id="wins">—</span></div>
    <div class="kv"><strong>Win-Rate:</strong> <span id="winrate">—</span></div>
    <div class="kv"><strong>KDA:</strong> <span id="kda">—</span></div>
    <div class="kv"><strong>Ø Kills:</strong> <span id="avgKills">—</span></div>
    <div class="kv"><strong>Ø Deaths:</strong> <span id="avgDeaths">—</span></div>
    <div class="kv"><strong>Ø Assists:</strong> <span id="avgAssists">—</span></div>
    <div class="kv"><strong>Ø Dauer:</strong> <span id="avgDuration">—</span></div>
    <div class="kv"><strong>Meist gespielt:</strong> <span id="mostChamp">—</span></div>
    <div class="kv"><strong>Beste WR (≥5):</strong> <span id="bestChamp">—</span></div>
  </div>

  <div>
    <h2>Teamkollegen (≥5 Spiele)</h2>
    <ul id="mateList"></ul>
  </div>

  <div>
    <h2>Top Items</h2>
    <ul id="items"></ul>
  </div>

  <div class="field" style="margin-top:20px">
    <label for="filter">Champion-Filter</label>
    <select id="filter"></select>
  </div>

  <div id="matchList"></div>
  <div class="pagination">
    <button id="prevPage" type="button">◀</button>
    <span id="pageInfo">0/0</span>
    <button id="nextPage" type="button">▶</button>
  </div>
</div>

<script>
(() => {
  const els = {
    importBtn: document.getElementById('importBtn'),
    importFile: document.getElementById('importFile'),
    importInfo: document.getElementById('importInfo'),
    name: document.getElementById('name'),
    filter: document.getElementById('filter'),
    matchList: document.getElementById('matchList'),
    prevPage: document.getElementById('prevPage'),
    nextPage: document.getElementById('nextPage'),
    pageInfo: document.getElementById('pageInfo'),
    games: document.getElementById('games'),
    wins: document.getElementById('wins'),
    winrate: document.getElementById('winrate'),
    kda: document.getElementById('kda'),
    avgKills: document.getElementById('avgKills'),
    avgDeaths: document.getElementById('avgDeaths'),
    avgAssists: document.getElementById('avgAssists'),
    avgDuration: document.getElementById('avgDuration'),
    mostChamp: document.getElementById('mostChamp'),
    bestChamp: document.getElementById('bestChamp'),
    mateList: document.getElementById('mateList'),
    items: document.getElementById('items')
  };
  let dataset = null;
  let matches = [];
  let itemData = null;
  let currentPage = 0;
  const PAGE_SIZE = 20;
  const itemDataPromise = fetch('https://ddragon.leagueoflegends.com/cdn/14.17.1/data/en_US/item.json')
    .then(r => r.json()).then(d => { itemData = d.data; });

  els.importBtn.addEventListener('click', () => els.importFile.click());
  els.importFile.addEventListener('change', async (e) => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    try {
      const text = await file.text();
      const obj = JSON.parse(text);
      if (!obj || !Array.isArray(obj.matches) || !obj.puuid) throw new Error('Ungültiges Format');
      dataset = obj;
      els.importInfo.textContent = `Importiert: ${obj.player || 'Unbekannt'} • Matches: ${obj.count ?? obj.matches.length}`;
      analyze();
    } catch (err) {
      console.error(err);
      els.importInfo.textContent = 'Import fehlgeschlagen.';
    } finally {
      e.target.value = '';
    }
  });

  function analyze() {
    const puuid = dataset.puuid;
    matches = dataset.matches.map(m => {
      const ps = m.info.participants || [];
      const me = ps.find(p => p.puuid === puuid);
      if (!me) return null;
      const teamId = me.playerSubteamId ?? me.subteamId;
      const mates = ps.filter(p => p !== me && ((p.playerSubteamId ?? p.subteamId) === teamId));
      const mate = mates[0];
      const placement = me.subteamPlacement ?? me.placement;
      const win = placement === 1 || me.win;
      const items = [];
      for (let i = 0; i <= 6; i++) {
        const id = me['item' + i];
        if (id) items.push(id);
      }
      const cs = (me.totalMinionsKilled || 0) + (me.neutralMinionsKilled || 0);
      return {
        id: m.id,
        timestamp: m.info.gameCreation || 0,
        duration: m.info.gameDuration || 0,
        champion: me.championName,
        k: me.kills || 0,
        d: me.deaths || 0,
        a: me.assists || 0,
        kda: ((me.kills || 0) + (me.assists || 0)) / Math.max(1, me.deaths || 0),
        gold: me.goldEarned || 0,
        damage: me.totalDamageDealtToChampions || 0,
        cs,
        win,
        items,
        teammateName: mate ? (mate.riotIdGameName || mate.summonerName || mate.puuid) : null,
        teammateChamp: mate ? mate.championName : null
      };
    }).filter(Boolean);
    matches.sort((a,b) => b.timestamp - a.timestamp);

    const champs = Array.from(new Set(matches.map(m => m.champion))).sort();
    els.filter.innerHTML = '<option value="">Alle Champions</option>' +
      champs.map(c => `<option value="${c}">${c}</option>`).join('');
    currentPage = 0;
    renderMatches();
    renderStats();
  }

  els.filter.addEventListener('change', () => { currentPage = 0; renderMatches(); });
  els.prevPage.addEventListener('click', () => { if (currentPage > 0) { currentPage--; renderMatches(); } });
  els.nextPage.addEventListener('click', () => { currentPage++; renderMatches(); });

  async function renderMatches() {
    await itemDataPromise;
    const champ = els.filter.value;
    const filtered = matches.filter(m => !champ || m.champion === champ);
    const totalPages = Math.ceil(filtered.length / PAGE_SIZE) || 1;
    if (currentPage >= totalPages) currentPage = totalPages - 1;
    const start = currentPage * PAGE_SIZE;
    const pageMatches = filtered.slice(start, start + PAGE_SIZE);
    els.matchList.innerHTML = pageMatches.map(m => {
      const items = m.items.map(id => itemData[id]?.name || id).join(', ');
      const date = m.timestamp ? new Date(m.timestamp).toLocaleDateString() : '';
      return `<details><summary><span>${date}</span><span>${m.champion}</span><span>${m.k}/${m.d}/${m.a} (${m.kda.toFixed(2)})</span><span>${m.win ? '✅' : '❌'}</span></summary>`+
        `<div class="details-content">Dauer: ${(m.duration/60).toFixed(1)}m<br/>Gold: ${m.gold}<br/>Damage: ${m.damage}<br/>CS: ${m.cs}<br/>Teamkollege: ${m.teammateName ? `${m.teammateName} (${m.teammateChamp})` : '—'}<br/>Items: ${items}</div></details>`;
    }).join('');
    els.pageInfo.textContent = `${filtered.length ? currentPage + 1 : 0}/${totalPages}`;
    els.prevPage.disabled = currentPage === 0;
    els.nextPage.disabled = currentPage >= totalPages - 1;
  }

  async function renderStats() {
    await itemDataPromise;
    const sum = matches.reduce((acc, m) => {
      acc.k += m.k; acc.d += m.d; acc.a += m.a; acc.duration += m.duration; return acc;
    }, { k: 0, d: 0, a: 0, duration: 0 });
    const total = matches.length;
    const wins = matches.filter(m => m.win).length;
    const kda = (sum.k + sum.a) / Math.max(1, sum.d);
    els.games.textContent = total;
    els.wins.textContent = wins;
    els.winrate.textContent = total ? ((wins * 100) / total).toFixed(1) + '%' : '—';
    els.kda.textContent = `${sum.k}/${sum.d}/${sum.a} (${kda.toFixed(2)})`;
    els.avgKills.textContent = (sum.k / Math.max(1,total)).toFixed(1);
    els.avgDeaths.textContent = (sum.d / Math.max(1,total)).toFixed(1);
    els.avgAssists.textContent = (sum.a / Math.max(1,total)).toFixed(1);
    els.avgDuration.textContent = (sum.duration / Math.max(1,total) / 60).toFixed(1) + 'm';

    const champStats = {};
    for (const m of matches) {
      const cs = champStats[m.champion] || { games:0, wins:0 };
      cs.games++; if (m.win) cs.wins++; champStats[m.champion] = cs;
    }
    let most = null; let best = null;
    for (const [champ, obj] of Object.entries(champStats)) {
      if (!most || obj.games > most.games) most = { champ, games: obj.games };
      const wr = obj.wins / obj.games;
      if (obj.games >= 5 && (!best || wr > best.wr)) best = { champ, wr, games: obj.games };
    }
    els.mostChamp.textContent = most ? `${most.champ} (${most.games})` : '—';
    els.bestChamp.textContent = best ? `${best.champ} (${(best.wr*100).toFixed(1)}%, ${best.games})` : '—';

    const mateStats = {};
    for (const m of matches) {
      if (!m.teammateName) continue;
      const obj = mateStats[m.teammateName] || { games:0, wins:0 };
      obj.games++; if (m.win) obj.wins++; mateStats[m.teammateName] = obj;
    }
    const mateList = Object.entries(mateStats).filter(([_,o]) => o.games >= 5)
      .sort((a,b) => b[1].games - a[1].games);
    els.mateList.innerHTML = mateList.map(([name,o]) =>
      `<li>${name}: ${(o.wins/o.games*100).toFixed(1)}% WR (${o.games})</li>`).join('');

    const items = {};
    for (const m of matches) {
      for (const id of m.items) {
        const obj = items[id] || { games: 0, wins: 0 };
        obj.games++;
        if (m.win) obj.wins++;
        items[id] = obj;
      }
    }
    const top = Object.entries(items).sort((a, b) => b[1].games - a[1].games).slice(0, 5);
    els.items.innerHTML = top.map(([id, obj]) => {
      const wr = obj.wins / obj.games;
      const name = itemData[id]?.name || id;
      return `<li>${name}: ${(wr * 100).toFixed(1)}% WR (${obj.games})</li>`;
    }).join('');
  }
})();
</script>
</body>
</html>
