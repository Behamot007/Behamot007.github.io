<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Anime Info Demo (Jikan API)</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    section { margin-bottom: 40px; }
    img { max-width: 150px; border-radius: 8px; margin: 5px; }
    .char-card { display: inline-block; text-align: center; margin: 10px; }
    pre { background: #f4f4f4; padding: 10px; border-radius: 8px; max-height: 400px; overflow: auto; }
    #status { margin: 10px 0; font-size: 14px; color: #555; }
    #openingNav { margin-top: 10px; }
    #openingNav button { margin: 0 5px; padding: 5px 10px; }
  </style>
</head>
<body>
  <h1>Anime Info Demo (Jikan API)</h1>

  <label for="animeSelect">Anime auswählen:</label>
  <select id="animeSelect"></select>
  <div id="status">Lade Anime Liste...</div>

  <section id="bilder">
    <h2>1. Bilder</h2>
    <div id="bilderContainer"></div>
  </section>

  <section id="charaktere">
    <h2>2. Charaktere</h2>
    <div id="charakterContainer"></div>
  </section>

  <section id="openings">
    <h2>3. Opening</h2>
    <div id="openingContainer"></div>
    <div id="openingNav" style="display:none;">
      <button id="prevOpening">◀ Zurück</button>
      <button id="nextOpening">Weiter ▶</button>
    </div>
  </section>

  <section id="infos">
    <h2>4. Alle Infos (JSON)</h2>
    <pre id="jsonContainer"></pre>
  </section>

  <script>
    const animeSelect = document.getElementById('animeSelect');
    const bilderContainer = document.getElementById('bilderContainer');
    const charakterContainer = document.getElementById('charakterContainer');
    const openingContainer = document.getElementById('openingContainer');
    const jsonContainer = document.getElementById('jsonContainer');
    const statusDiv = document.getElementById('status');
    const prevBtn = document.getElementById('prevOpening');
    const nextBtn = document.getElementById('nextOpening');
    const openingNav = document.getElementById('openingNav');

    let currentOpenings = [];
    let currentOpeningIndex = 0;

    async function loadAnimeList() {
      animeSelect.innerHTML = '';
      statusDiv.textContent = "Lade Anime Liste...";

      for (let page = 1; page <= 4; page++) {
        try {
          statusDiv.textContent = `Lade Seite ${page} von 4...`;
          const res = await fetch(`https://api.jikan.moe/v4/top/anime?page=${page}&limit=25`);
          if (!res.ok) {
            console.warn(`Seite ${page} konnte nicht geladen werden (Status ${res.status})`);
            continue;
          }
          const data = await res.json();
          if (data && data.data && Array.isArray(data.data)) {
            data.data.forEach(anime => {
              const opt = document.createElement('option');
              opt.value = anime.mal_id;
              opt.textContent = anime.title;
              animeSelect.appendChild(opt);
            });
          }
          await new Promise(resolve => setTimeout(resolve, 1200));
        } catch (err) {
          console.error("Fehler beim Laden der Anime-Liste (Seite " + page + "):", err);
        }
      }
      statusDiv.textContent = "Anime Liste geladen.";

      if (animeSelect.options.length > 0) {
        loadAnimeDetails(animeSelect.options[0].value);
      }
    }

    async function loadAnimeDetails(animeId) {
      try {
        const res = await fetch(`https://api.jikan.moe/v4/anime/${animeId}/full`);
        if (!res.ok) {
          jsonContainer.textContent = `Fehler beim Laden der Anime-Details (Status ${res.status})`;
          return;
        }
        const animeData = await res.json();
        const anime = animeData.data;

        if (!anime) {
          jsonContainer.textContent = "Keine Daten gefunden.";
          return;
        }

        // 1. Bilder
        bilderContainer.innerHTML = '';
        const images = [anime.images?.jpg?.image_url, anime.images?.webp?.image_url, anime.images?.jpg?.large_image_url, anime.images?.webp?.large_image_url];
        images.slice(0,4).forEach(url => {
          if (url) {
            const img = document.createElement('img');
            img.src = url;
            bilderContainer.appendChild(img);
          }
        });

        // 2. Charaktere
        const charRes = await fetch(`https://api.jikan.moe/v4/anime/${animeId}/characters`);
        if (charRes.ok) {
          const charData = await charRes.json();
          charakterContainer.innerHTML = '';
          if (charData && charData.data) {
            charData.data.slice(0,4).forEach(c => {
              const div = document.createElement('div');
              div.className = 'char-card';
              div.innerHTML = `<img src="${c.character.images.jpg.image_url}" alt="${c.character.name}"><br>${c.character.name}`;
              charakterContainer.appendChild(div);
            });
          }
        }

        // 3. Openings mit Navigation
        currentOpenings = (anime.theme && anime.theme.openings) ? anime.theme.openings : [];
        currentOpeningIndex = 0;
        showOpening();

        // 4. JSON Infos anzeigen
        jsonContainer.textContent = JSON.stringify(anime, null, 2);
      } catch (err) {
        console.error("Fehler beim Laden der Anime-Details:", err);
      }
    }

    function showOpening() {
      openingContainer.innerHTML = '';
      if (currentOpenings.length === 0) {
        openingContainer.textContent = 'Keine Opening-Infos gefunden.';
        openingNav.style.display = 'none';
        return;
      }

      const openingText = currentOpenings[currentOpeningIndex];
      const ytMatch = openingText.match(/https?:\/\/[^\s]+/);
      if (ytMatch) {
        openingContainer.innerHTML = `<iframe width="560" height="315" src="${ytMatch[0].replace('watch?v=', 'embed/')}" frameborder="0" allowfullscreen></iframe>`;
      } else {
        openingContainer.textContent = openingText;
      }

      openingNav.style.display = 'block';
    }

    prevBtn.addEventListener('click', () => {
      if (currentOpenings.length > 0) {
        currentOpeningIndex = (currentOpeningIndex - 1 + currentOpenings.length) % currentOpenings.length;
        showOpening();
      }
    });

    nextBtn.addEventListener('click', () => {
      if (currentOpenings.length > 0) {
        currentOpeningIndex = (currentOpeningIndex + 1) % currentOpenings.length;
        showOpening();
      }
    });

    animeSelect.addEventListener('change', e => loadAnimeDetails(e.target.value));

    loadAnimeList();
  </script>
</body>
</html>
