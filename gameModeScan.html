<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Play Screen</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #121212;
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }

    h1 {
      font-size: 1.5rem;
      margin-bottom: 20px;
      color: #1DB954;
    }

    #reader {
      width: 100%;
      max-width: 320px;
      margin-bottom: 20px;
    }

    .controls {
      display: flex;
      gap: 20px;
    }

    button {
      flex: 1;
      padding: 20px;
      font-size: 1.2rem;
      border: none;
      border-radius: 12px;
      background: #1DB954;
      color: white;
      font-weight: bold;
    }

    button:active {
      background: #14833b;
    }
  </style>
</head>

<body>
  <h1>Play Screen</h1>
  <div id="reader"></div>
  <div id="scanResult"></div>

  <div class="controls">
    <button id="actionBtn">üì∑ Scan</button>
    <button id="nextBtn">‚è≠ Weiter</button>
  </div>

  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script src="https://sdk.scdn.co/spotify-player.js"></script>
  <script src="spotify.js"></script>
  <script>
    let player, currentTrackId = null;
    let html5QrCode, scanning = false,
      playing = false;

    // === Spotify Funktionen ===
    let deviceId = null;

    function initSpotifyPlayer() {
      window.onSpotifyWebPlaybackSDKReady = () => {
        player = new Spotify.Player({
          name: 'QR Player',
          getOAuthToken: cb => cb(SPOTIFY_TOKEN)
        });

        // Device bereit
        player.addListener('ready', ({
          device_id
        }) => {
          console.log('Spotify Player ready:', device_id);
          deviceId = device_id;
          // Dieses Ger√§t als aktives Playback setzen
          setActiveDevice(device_id);
        });

        player.addListener('not_ready', ({
          device_id
        }) => {
          console.warn('Ger√§t offline:', device_id);
        });

        player.connect();
      };
    }

    async function setActiveDevice(id) {
      const resp = await fetch("https://api.spotify.com/v1/me/player", {
        method: "PUT",
        headers: {
          "Authorization": `Bearer ${SPOTIFY_TOKEN}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          device_ids: [id],
          play: false
        })
      });
      if (!resp.ok) console.error("Device konnte nicht gesetzt werden:", await resp.text());
    }


    async function playTrack(trackId) {
      if (!deviceId) {
        console.error("Kein Spotify Device aktiv!");
        return;
      }
      currentTrackId = trackId;
      const resp = await fetch(`https://api.spotify.com/v1/me/player/play?device_id=${deviceId}`, {
        method: "PUT",
        headers: {
          "Authorization": `Bearer ${SPOTIFY_TOKEN}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          uris: [`spotify:track:${trackId}`]
        })
      });
      if (!resp.ok) {
        console.error("Fehler beim Starten:", await resp.text());
      } else {
        playing = true;
        updateActionBtn();
      }
    }


    async function pauseTrack() {
      await fetch(`https://api.spotify.com/v1/me/player/pause`, {
        method: "PUT",
        headers: {
          "Authorization": `Bearer ${SPOTIFY_TOKEN}`
        }
      });
      playing = false;
      updateActionBtn();
    }

    // === UI Steuerung ===
    function updateActionBtn() {
      const btn = document.getElementById("actionBtn");
      if (scanning) btn.textContent = "üì∑ Scannen l√§uft...";
      else if (playing) btn.textContent = "‚è∏ Pause";
      else btn.textContent = "‚ñ∂ Play";
    }

    // === QR-Scanner ===
    function startScanner() {
      if (scanning) return;
      html5QrCode = new Html5Qrcode("reader");
      scanning = true;
      updateActionBtn();

      html5QrCode.start({
          facingMode: "environment"
        }, {
          fps: 10,
          qrbox: 250
        },
        msg => {
          if (msg.includes("spotify.com/track/")) {
            const trackId = msg.split("track/")[1].split("?")[0];
            html5QrCode.stop().then(() => {
              scanning = false;
              playTrack(trackId);
              document.getElementById("scanResult").textContent = "‚úÖ Song gestartet!";
            });
          }
        },
        () => {}
      ).catch(err => console.error("Scanner Fehler:", err));
    }

    // === Button Events ===
    document.getElementById("actionBtn").addEventListener("click", () => {
      if (scanning) return; // l√§uft schon
      if (!playing) startScanner();
      else pauseTrack();
    });

    document.getElementById("nextBtn").addEventListener("click", async () => {
      await pauseTrack();
      startScanner();
    });

    // === Init ===
    initSpotifyPlayer();
  </script>
</body>

</html>
