<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>Anime Guessing Game</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        section {
            margin-bottom: 40px;
        }

        img {
            max-width: 150px;
            border-radius: 8px;
            margin: 5px;
        }

        .char-card {
            display: inline-block;
            text-align: center;
            margin: 10px;
        }

        #openingNav {
            margin-top: 10px;
        }

        #openingNav button {
            margin: 0 5px;
            padding: 5px 10px;
        }

        #score {
            font-size: 18px;
            font-weight: bold;
        }

        #round {
            font-size: 18px;
            margin-top: 10px;
        }

        button.reveal,
        #nextRound {
            margin: 10px;
            padding: 5px 10px;
        }

        #answerSection {
            margin-top: 20px;
        }
    </style>
</head>

<body>
    <h1>Anime Guessing Game</h1>
    <div id="status">Lade Anime Liste...</div>
    <div id="score">Punkte: 100</div>
    <div id="round">Runde: 1 / 4</div>

    <section id="openings">
        <h2>Opening</h2>
        <div id="openingContainer"></div>
        <div id="openingNav" style="display:none;">
            <button id="prevOpening">◀ Zurück</button>
            <button id="nextOpening">Weiter ▶</button>
        </div>
    </section>

    <section id="charaktere">
        <h2>Charaktere</h2>
        <div id="charakterContainer"></div>
        <button class="reveal" id="revealChar">Nächsten Charakter anzeigen (-20 Punkte)</button>
    </section>

    <section id="cover">
        <h2>Cover</h2>
        <div id="coverContainer"></div>
        <button class="reveal" id="revealCover">Cover anzeigen (-30 Punkte)</button>
    </section>

    <section id="answerSection">
        <h2>Deine Antwort</h2>
        <select id="answerSelect">
            <option value="">Anime auswählen</option>
        </select>
        <button id="submitAnswer">Antwort prüfen</button>
        <div id="answerFeedback" style="margin-top:10px; font-weight:bold;"></div>
    </section>


    <button id="nextRound" style="display:none;">Nächste Runde starten</button>
    <button id="newGame" style="display:none;">Neues Spiel starten</button>

    <div id="finalResult" style="font-size:20px; font-weight:bold;"></div>

<script>
const statusDiv = document.getElementById('status');
const openingContainer = document.getElementById('openingContainer');
const openingNav = document.getElementById('openingNav');
const prevBtn = document.getElementById('prevOpening');
const nextBtn = document.getElementById('nextOpening');
const charakterContainer = document.getElementById('charakterContainer');
const revealCharBtn = document.getElementById('revealChar');
const coverContainer = document.getElementById('coverContainer');
const revealCoverBtn = document.getElementById('revealCover');
const scoreDiv = document.getElementById('score');
const roundDiv = document.getElementById('round');
const nextRoundBtn = document.getElementById('nextRound');
const newGameBtn   = document.getElementById('newGame');
const finalResultDiv = document.getElementById('finalResult');
const answerSelect = document.getElementById('answerSelect');
const submitAnswerBtn = document.getElementById('submitAnswer');
const answerFeedback = document.getElementById('answerFeedback');

let allAnime = [];
let usedAnimeIds = [];
let currentOpenings = [];
let currentOpeningIndex = 0;
let characters = [];
let charIndex = 0;
let score = 100;
let round = 1;
const maxRounds = 4;
let totalScore = 0;
let currentAnimeTitle = "";
let answeredCorrectly = false;

function loadSession() {
    totalScore = parseInt(localStorage.getItem('animeGameTotalScore')) || 0;
    round = parseInt(localStorage.getItem('animeGameRound')) || 1;
}

function saveSession() {
    localStorage.setItem('animeGameTotalScore', totalScore);
    localStorage.setItem('animeGameRound', round);
}

function updateScore(points) {
    score -= points;
    if (score < 0) score = 0;
    scoreDiv.textContent = `Punkte: ${score}`;
}

async function loadAllAnime() {
    allAnime = [];
    for (let page = 1; page <= 5; page++) {
        try {
            const res = await fetch(`https://api.jikan.moe/v4/top/anime?page=${page}&limit=25`);
            if (!res.ok) continue;
            const data = await res.json();
            if (data && data.data) allAnime = allAnime.concat(data.data);
            await new Promise(r => setTimeout(r, 1200));
        } catch (e) { console.error(e); }
    }
    pickRandomAnime();
    populateAnswerSelect();
    statusDiv.textContent = "Fertig! Wähle zufälligen Anime...";
}

function pickRandomAnime() {
    // Anime wählen, der noch nicht genutzt wurde
    const remaining = allAnime.filter(a => !usedAnimeIds.includes(a.mal_id));
    if (remaining.length === 0) {
        console.log("Keine neuen Animes mehr verfügbar");
        return;
    }
    const randomAnime = remaining[Math.floor(Math.random() * remaining.length)];
    usedAnimeIds.push(randomAnime.mal_id);
    
    // Aktuellen Anime speichern und Dropdown vorbereiten
    currentAnimeTitle = randomAnime.title;
    populateAnswerSelect()
    
    loadAnimeDetails(randomAnime.mal_id);
}

function populateAnswerSelect() {
    const select = document.getElementById('answerSelect');
    select.innerHTML = `<option value="">Anime auswählen</option>`;

    // Nur die Titel extrahieren
    const titles = allAnime.map(a => a.title);

    // Alphabetisch sortieren
    titles.sort((a, b) => a.localeCompare(b, 'de', { sensitivity: 'base' }));

    // Optionen erstellen
    titles.forEach(title => {
        const option = document.createElement('option');
        option.value = title;
        option.textContent = title;
        select.appendChild(option);
    });
}



async function loadAnimeDetails(animeId) {
    try {
        const res = await fetch(`https://api.jikan.moe/v4/anime/${animeId}/full`);
        const data = await res.json();
        const anime = data.data;
        currentAnimeTitle = anime.title;
        answeredCorrectly = false;

        // Openings vorbereiten
        currentOpenings = anime.opening_themes || [];
        currentOpeningIndex = 0;
        showOpening();

        // Charaktere
        const charRes = await fetch(`https://api.jikan.moe/v4/anime/${animeId}/characters`);
        const charData = await charRes.json();
        characters = charData.data.slice(0, 4);
        charIndex = 0;
        charakterContainer.innerHTML = '';

        // Cover
        coverContainer.innerHTML = '';
        if (anime.images && anime.images.jpg && anime.images.jpg.image_url) {
            coverContainer.dataset.url = anime.images.jpg.image_url;
        }

        statusDiv.textContent = `Anime für Runde ${round} geladen!`;
    } catch (err) {
        console.error(err);
    }
}

function showOpening() {
    openingContainer.innerHTML = '';
    if (currentOpenings.length === 0) {
        openingContainer.textContent = 'Keine Opening-Infos gefunden.';
        openingNav.style.display = 'none';
        return;
    }
    const openingText = currentOpenings[currentOpeningIndex];
    const ytMatch = openingText.match(/https?:\/\/[^\s]+/);
    if (ytMatch) {
        openingContainer.innerHTML = `<iframe width="560" height="315" src="${ytMatch[0].replace('watch?v=', 'embed/')}" frameborder="0" allowfullscreen></iframe>`;
    } else {
        openingContainer.textContent = openingText;
    }
    openingNav.style.display = 'block';
}

prevBtn.addEventListener('click', () => {
    if (currentOpenings.length > 0) {
        currentOpeningIndex = (currentOpeningIndex - 1 + currentOpenings.length) % currentOpenings.length;
        showOpening();
    }
});

nextBtn.addEventListener('click', () => {
    if (currentOpenings.length > 0) {
        currentOpeningIndex = (currentOpeningIndex + 1) % currentOpenings.length;
        showOpening();
    }
});

revealCharBtn.addEventListener('click', () => {
    if (charIndex < characters.length) {
        const c = characters[charIndex];
        const div = document.createElement('div');
        div.className = 'char-card';
        div.innerHTML = `<img src="${c.character.images.jpg.image_url}" alt="${c.character.name}"><br>${c.character.name}`;
        charakterContainer.appendChild(div);
        charIndex++;
        updateScore(20);
    }
});

revealCoverBtn.addEventListener('click', () => {
    if (coverContainer.dataset.url && coverContainer.innerHTML === '') {
        const img = document.createElement('img');
        img.src = coverContainer.dataset.url;
        coverContainer.appendChild(img);
        updateScore(30);
    }
});

submitAnswerBtn.addEventListener('click', () => {
    const answer = answerSelect.value;
    if (!answer) return;

    if (answer === currentAnimeTitle) {
        totalScore += score;
        answerFeedback.textContent = `Richtig! Es war ${currentAnimeTitle}. Du bekommst ${score} Punkte.`;
    } else {
        answerFeedback.textContent = `Falsch! Es war ${currentAnimeTitle}. Du bekommst 0 Punkte.`;
    }

    answeredCorrectly = true;
    nextRoundBtn.style.display = 'block';
    saveSession();
});

function startNewGame() {
    totalScore = 0;
    round = 1;
    score = 100;
    answeredCorrectly = false;
    currentAnimeTitle = "";
    usedAnimeIds = [];

    // UI zurücksetzen
    answerFeedback.textContent = '';
    finalResultDiv.textContent = '';
    scoreDiv.textContent = `Punkte: ${score}`;
    roundDiv.textContent = `Runde: ${round} / ${maxRounds}`;
    charakterContainer.innerHTML = '';
    coverContainer.innerHTML = '';
    openingContainer.innerHTML = '';
    document.getElementById('answerSelect').innerHTML = '<option value="">Anime auswählen</option>';

    // Buttons
    newGameBtn.style.display = 'none';
    nextRoundBtn.style.display = 'none';

    // Neuen Anime laden
    pickRandomAnime();
}

function startNextRound() {
    round++;

    if (round > maxRounds) {
        finalResultDiv.textContent = `Spiel vorbei! Gesamtscore: ${totalScore}`;
        nextRoundBtn.style.display = 'none';
        newGameBtn.style.display = 'block'; // Nur neuer Spiel-Button sichtbar
        return;
    }

    // Reset für nächste Runde
    score = 100;
    answeredCorrectly = false;
    scoreDiv.textContent = `Punkte: ${score}`;
    roundDiv.textContent = `Runde: ${round} / ${maxRounds}`;
    charakterContainer.innerHTML = '';
    coverContainer.innerHTML = '';
    answerFeedback.textContent = '';
    document.getElementById('answerSelect').innerHTML = '<option value="">Anime auswählen</option>';
    openingContainer.innerHTML = '';
    nextRoundBtn.style.display = 'none';

    pickRandomAnime();
}

// Event Listener
nextRoundBtn.addEventListener('click', startNextRound);
newGameBtn.addEventListener('click', startNewGame);


loadSession();
roundDiv.textContent = `Runde: ${round} / ${maxRounds}`;
scoreDiv.textContent = `Punkte: ${score}`;
loadAllAnime();
</script>

</body>

</html>